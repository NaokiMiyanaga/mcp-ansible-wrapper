---
- name: Inventory overview (groups and hosts)
  hosts: localhost
  gather_facts: false
  vars:
    groups_sorted: "{{ groups.keys() | list | sort }}"
    hosts_all: "{{ groups['all'] | default([]) | list | sort }}"
  tasks:
    - name: Inventory summary
      ansible.builtin.debug:
        msg:
          groups: "{{ groups_sorted }}"
          hosts_all: "{{ hosts_all }}"

    - name: Group membership
      ansible.builtin.debug:
        msg:
          group: "{{ item }}"
          count: "{{ (groups[item] | default([])) | length }}"
          hosts: "{{ (groups[item] | default([])) | sort }}"
      loop: "{{ groups_sorted }}"

- name: Network overview (per host)
  hosts: all
  gather_facts: false
  become: true
  vars:
    # flags will be derived by detection task
    has_ip: false
    has_bridge: false
    has_vtysh: false
    has_lldpctl: false
  tasks:
    - name: Detect available tools
      ansible.builtin.shell: |
        for bin in ip bridge vtysh lldpctl; do
          if command -v "$bin" >/dev/null 2>&1; then echo "$bin:1"; else echo "$bin:0"; fi
        done
      register: tools_detect
      changed_when: false

    - name: Set tool flags
      ansible.builtin.set_fact:
        has_ip: "{{ tools_detect.stdout is search('ip:1') }}"
        has_bridge: "{{ tools_detect.stdout is search('bridge:1') }}"
        has_vtysh: "{{ tools_detect.stdout is search('vtysh:1') }}"
        has_lldpctl: "{{ tools_detect.stdout is search('lldpctl:1') }}"

    - name: ip -brief address
      ansible.builtin.command: ip -brief address
      register: if_addr
      changed_when: false
      when: has_ip

    - name: ip -brief link
      ansible.builtin.command: ip -brief link
      register: if_link
      changed_when: false
      when: has_ip

    - name: ip route (IPv4)
      ansible.builtin.command: ip route
      register: route4
      changed_when: false
      when: has_ip

    - name: ip -6 route (IPv6)
      ansible.builtin.shell: ip -6 route || true
      register: route6
      changed_when: false
      when: has_ip

    - name: ip neigh (ARP/ND)
      ansible.builtin.shell: ip neigh || true
      register: neigh
      changed_when: false
      when: has_ip

    - name: bridge link show
      ansible.builtin.shell: bridge link show || true
      register: br_link
      changed_when: false
      when: has_bridge

    - name: bridge vlan show
      ansible.builtin.shell: bridge vlan show || true
      register: br_vlan
      changed_when: false
      when: has_bridge

    - name: bridge fdb show
      ansible.builtin.shell: bridge fdb show || true
      register: br_fdb
      changed_when: false
      when: has_bridge

    - name: FRR show bgp summary (if vtysh exists)
      ansible.builtin.shell: |
        vtysh -c "show bgp summary" || true
      register: frr_bgp
      changed_when: false
      failed_when: false
      when: has_vtysh

    - name: FRR show ip ospf neighbor (if vtysh exists)
      ansible.builtin.shell: |
        vtysh -c "show ip ospf neighbor" || true
      register: frr_ospf
      changed_when: false
      failed_when: false
      when: has_vtysh

    - name: LLDP neighbors (if lldpctl exists)
      ansible.builtin.shell: |
        lldpctl 2>/dev/null || true
      register: lldp
      changed_when: false
      when: has_lldpctl

    - name: Output summary
      ansible.builtin.debug:
        msg:
          tools:
            ip: "{{ has_ip }}"
            bridge: "{{ has_bridge }}"
            vtysh: "{{ has_vtysh }}"
            lldpctl: "{{ has_lldpctl }}"
          address: "{{ if_addr.stdout_lines | default([]) }}"
          link: "{{ if_link.stdout_lines | default([]) }}"
          route_v4: "{{ route4.stdout_lines | default([]) }}"
          route_v6: "{{ route6.stdout_lines | default([]) }}"
          neigh: "{{ neigh.stdout_lines | default([]) }}"
          bridge_link: "{{ br_link.stdout_lines | default([]) }}"
          bridge_vlan: "{{ br_vlan.stdout_lines | default([]) }}"
          bridge_fdb: "{{ br_fdb.stdout_lines | default([]) }}"
          frr_bgp: "{{ frr_bgp.stdout_lines | default([]) }}"
          frr_ospf: "{{ frr_ospf.stdout_lines | default([]) }}"
          lldp: "{{ lldp.stdout_lines | default([]) }}"
