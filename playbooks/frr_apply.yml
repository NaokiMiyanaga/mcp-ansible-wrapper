---
- name: Apply FRR BGP intent (from policy)
  hosts: frr
  gather_facts: false
  vars:
    host_key: "{{ inventory_hostname.split('.')[0] }}"
    host_cfg: "{{ frr_apply.get(host_key) | default({}) }}"
  tasks:
    - name: Validate host intent exists
      ansible.builtin.assert:
        that:
          - host_cfg is mapping
          - host_cfg.asn is defined
          - host_cfg.router_id is defined
        fail_msg: "No FRR intent for {{ host_key }} or missing ASN/router_id"

    - name: Show intended BGP config
      ansible.builtin.debug:
        var: host_cfg

    - name: Read current FRR running-config
      ansible.builtin.command:
        argv: ["vtysh", "-c", "show running-config"]
      register: frr_running
      changed_when: false

    - name: Ensure BGP ASN exists
      ansible.builtin.command:
        argv:
          - vtysh
          - -c
          - "configure terminal"
          - -c
          - "router bgp {{ host_cfg.asn }}"
      when: ("router bgp " ~ host_cfg.asn | string) not in (frr_running.stdout | default(""))
      notify: write frr config

    - name: Ensure BGP router-id configured
      ansible.builtin.command:
        argv:
          - vtysh
          - -c
          - "configure terminal"
          - -c
          - "router bgp {{ host_cfg.asn }}"
          - -c
          - "bgp router-id {{ host_cfg.router_id }}"
      when: ("bgp router-id " ~ host_cfg.router_id) not in (frr_running.stdout | default(""))
      notify: write frr config

    - name: Ensure BGP neighbors configured
      ansible.builtin.command:
        argv:
          - vtysh
          - -c
          - "configure terminal"
          - -c
          - "router bgp {{ host_cfg.asn }}"
          - -c
          - "neighbor {{ item.ip }} remote-as {{ item.remote_as }}"
      loop: "{{ host_cfg.neighbors | default([]) }}"
      loop_control:
        label: "{{ item.ip }} -> AS{{ item.remote_as }}"
      when: ("neighbor " ~ item.ip ~ " remote-as " ~ (item.remote_as | string)) not in (frr_running.stdout | default(""))
      notify: write frr config

  handlers:
    - name: write frr config
      ansible.builtin.command:
        argv: ["vtysh", "-c", "write memory"]
      changed_when: true
