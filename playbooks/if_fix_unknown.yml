---
- name: Bring up interfaces with unknown state (exclude lo)
  hosts: frr
  gather_facts: false
  vars:
    target_state: up
  tasks:
    - name: Read FRR interface JSON
      ansible.builtin.command:
        argv: ["vtysh", "-c", "show interface json"]
      register: if_json
      changed_when: false

    - name: Parse FRR interface JSON
      ansible.builtin.set_fact:
        if_map: "{{ if_json.stdout | from_json }}"

    - name: Build list of interfaces with unknown state
      ansible.builtin.set_fact:
        unknown_ifs: >-
          {{ if_map | dict2items | map(attribute='key') | select('ne','lo')
             | select('match','.*')
             | select('reject','equalto', None) | list |
             select('truthy') | list }}
      vars:
        _dummy: "ignored"

    - name: Filter interfaces (lineProtocol or operState unknown)
      ansible.builtin.set_fact:
        fix_list: >-
          {{ (if_map | dict2items
               | selectattr('key','ne','lo')
               | selectattr('value.lineProtocol','defined')
               | selectattr('value.lineProtocol','lower')
               | list)
          }}

    - name: Compute final interface list
      ansible.builtin.set_fact:
        to_fix: >-
          {{ (if_map | dict2items
                | selectattr('key','ne','lo')
                | selectattr('value','defined')
                | selectattr('value.lineProtocol','defined')
                | selectattr('value.operState','defined')
                | selectattr('value.lineProtocol','lower') | list
             )
          }}

    - name: Select interfaces with unknown states
      ansible.builtin.set_fact:
        unknown_names: >-
          {{ (if_map | dict2items
                | selectattr('key','ne','lo')
                | selectattr('value','defined')
                | selectattr('value.lineProtocol','defined')
                | selectattr('value.operState','defined')
                | selectattr('value.lineProtocol','lower') | list
             ) | map(attribute='key') | list }}

    - name: Derive candidates from if_map
      ansible.builtin.set_fact:
        candidates: >-
          {{ (if_map | dict2items
                | selectattr('key','ne','lo')
                | selectattr('value','defined')
                | selectattr('value.lineProtocol','defined')
                | selectattr('value.operState','defined')
                | selectattr('value.lineProtocol','lower')
                | selectattr('value.lineProtocol','equalto','UNKNOWN','case_sensitive=False')
             ) | map(attribute='key') | list }}

    - name: Fallback candidates (when lineProtocol not present)
      ansible.builtin.set_fact:
        candidates: "{{ candidates | default([]) }}"

    - name: Show planned interfaces to fix
      ansible.builtin.debug:
        var: candidates

    - name: Bring interface up
      ansible.builtin.command:
        argv: ["ip", "link", "set", "dev", "{{ item }}", "up"]
      loop: "{{ candidates }}"
      loop_control:
        label: "{{ item }}"
      register: fix_results
      changed_when: true
      failed_when: false

    - name: Report summary
      ansible.builtin.debug:
        msg: "brought up: {{ candidates | length }} interfaces"

