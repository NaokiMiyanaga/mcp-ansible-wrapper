---
- name: bgp ops for {{ host | default('all') }}
  hosts: "{{ host | default('all') }}"
  gather_facts: no
  tasks:
    - name: Check vtysh presence
      ansible.builtin.shell: command -v vtysh || true
      register: vtysh_path
      changed_when: false

    - name: Strict mode fail when vtysh missing
      ansible.builtin.fail:
        msg: |
          Machine summary (JSON):
          {"code":"no_vtysh_strict","message":"vtysh not found (strict mode)","hint":"Target FRR device may not be reachable from current Ansible connection."}
      when: (vtysh_path.stdout == "") and ((strict_frr | default(true)) | bool)

    - name: show bgp status (when vtysh exists)
      ansible.builtin.shell: |
        vtysh -c 'show ip bgp summary' || true
      register: out
      when: vtysh_path.stdout != ""

    - name: print bgp summary
      ansible.builtin.debug:
        msg: "{{ out.stdout | default('') }}"
      when: vtysh_path.stdout != ""

    - name: summarize bgp (machine json)
      when: vtysh_path.stdout != ""
      vars:
        _lines: "{{ out.stdout | split('\n') }}"
        # シンプル: 隣接行は先頭がIPv4で始まる行
        _neigh_lines: "{{ _lines | select('match', '^\\s*\\d+\\.\\d+\\.\\d+\\.\\d+\\s+') | list }}"
        _peers_total: "{{ (_neigh_lines | length) | int }}"
        # Established とみなす行: 行末のトークンが数値
        _est_lines: "{{ _lines | select('match', '^\\s*\\d+\\.\\d+\\.\\d+\\.\\d+.*\\s\\d+\\s*$') | list }}"
        _peers_established: "{{ (_est_lines | length) | int }}"
        _rid_line: "{{ (_lines | select('match', '^BGP router identifier\\s+') | list) | first | default('') }}"
        _asn_line: "{{ (_lines | select('search', 'local AS number\\s+\\d+') | list) | first | default('') }}"
      ansible.builtin.set_fact:
        bgp_summary:
          impl: "FRR"
          router_id: "{{ _rid_line | regex_replace('^BGP router identifier\\s+([^,\\s]+).*$','\\1') }}"
          local_as: "{{ (_asn_line | regex_replace('^.*local AS number\\s+(\\d+).*$','\\1')) | int if (_asn_line | length) > 0 else omit }}"
          peers_total: "{{ _peers_total }}"
          peers_established: "{{ _peers_established }}"
          peers_down: "{{ (_peers_total - _peers_established) }}"

    # Optional: debug variables (disabled by default)
    #- name: debug bgp parsed vars
    #  when: vtysh_path.stdout != ""
    #  ansible.builtin.debug:
    #    msg: |
    #      [debug] peers_total={{ _peers_total }} peers_established={{ _peers_established }} rid={{ _rid_list | first | default('') }} asn={{ _asn_list | first | default('') }}

    - name: print machine summary (json)
      when: vtysh_path.stdout != ""
      ansible.builtin.debug:
        msg: |
          Machine summary (JSON):
          {{ bgp_summary | to_json }}
