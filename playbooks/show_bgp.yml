---
- name: bgp ops for {{ host | default('all') }}
  hosts: "{{ host | default('all') }}"
  gather_facts: no
  tasks:
    - name: Check vtysh presence
      ansible.builtin.shell: command -v vtysh || true
      register: vtysh_path
      changed_when: false

    - name: Strict mode fail when vtysh missing
      ansible.builtin.fail:
        msg: |
          Machine summary (JSON):
          {"code":"no_vtysh_strict","message":"vtysh not found (strict mode)","hint":"Target FRR device may not be reachable from current Ansible connection."}
      when: (vtysh_path.stdout == "") and ((strict_frr | default(true)) | bool)

    - name: show bgp status (when vtysh exists)
      ansible.builtin.shell: |
        vtysh -c 'show ip bgp summary' || true
      register: out
      when: vtysh_path.stdout != ""

    - name: print bgp summary
      ansible.builtin.debug:
        msg: "{{ out.stdout | default('') }}"
      when: vtysh_path.stdout != ""

    - name: summarize bgp (machine json)
      when: vtysh_path.stdout != ""
      vars:
        _tot_list: '{{ out.stdout | regex_findall("Total number of neighbors\\s*(\\d+)") }}'
        # FRR列構造に基づき State/PfxRcd 列の数値を抽出（Establishedのとき数値、Down/Idle等は非数）
        _est_list: '{{ out.stdout | regex_findall("(?m)^\\s*\\d+\\.\\d+\\.\\d+\\.\\d+\\s+\\d+\\s+\\d+\\s+\\d+\\s+\\d+\\s+\\d+\\s+\\d+\\s+\\d+\\s+\\S+\\s+(\\d+)") }}'
        _est: '{{ (_est_list | length) | string }}'
        _rid_list: '{{ out.stdout | regex_findall("BGP router identifier\\s+(\\S+)") }}'
        _asn_list: '{{ out.stdout | regex_findall("local AS number\\s+(\\d+)") }}'
      ansible.builtin.set_fact:
        bgp_summary:
          impl: "FRR"
          router_id: "{{ (_rid_list | first | default('')) }}"
          local_as: "{{ ((_asn_list | first | default('')) | int) if ((_asn_list | length) > 0) else omit }}"
          peers_total: "{{ ((_tot_list | first | default('0')) | int) }}"
          peers_established: "{{ _est | int }}"
          peers_down: "{{ (((_tot_list | first | default('0')) | int) - (_est | int)) }}"

    - name: debug bgp parsed vars
      when: vtysh_path.stdout != ""
      ansible.builtin.debug:
        msg: |
          [debug] _tot_list={{ _tot_list | to_json }} _est_list={{ _est_list | to_json }} _rid_list={{ _rid_list | to_json }} _asn_list={{ _asn_list | to_json }}

    - name: print machine summary (json)
      when: vtysh_path.stdout != ""
      ansible.builtin.debug:
        msg: |
          Machine summary (JSON):
          {{ bgp_summary | to_json }}
